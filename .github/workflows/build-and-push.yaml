name: Build, Push & Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: 10.200.70.45:30500
  BACKEND_IMAGE: 10.200.70.45:30500/policy-rag/backend
  FRONTEND_IMAGE: 10.200.70.45:30500/policy-rag/frontend

jobs:
  build-and-deploy:
    runs-on: [self-hosted, k3s, policy-rag]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "tag=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "Image tag: ${SHORT_SHA}"

      - name: Build backend image
        run: |
          docker build \
            -t ${{ env.BACKEND_IMAGE }}:${{ steps.tag.outputs.tag }} \
            -t ${{ env.BACKEND_IMAGE }}:latest \
            -f backend/Dockerfile.prod \
            backend/

      - name: Build frontend image
        run: |
          docker build \
            -t ${{ env.FRONTEND_IMAGE }}:${{ steps.tag.outputs.tag }} \
            -t ${{ env.FRONTEND_IMAGE }}:latest \
            -f frontend/Dockerfile.prod \
            frontend/

      - name: Push backend image
        run: |
          docker push ${{ env.BACKEND_IMAGE }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.BACKEND_IMAGE }}:latest

      - name: Push frontend image
        run: |
          docker push ${{ env.FRONTEND_IMAGE }}:${{ steps.tag.outputs.tag }}
          docker push ${{ env.FRONTEND_IMAGE }}:latest

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k k8s/base/

          # Update image tags to force rollout
          kubectl set image deployment/backend \
            backend=${{ env.BACKEND_IMAGE }}:${{ steps.tag.outputs.tag }} \
            -n policy-rag

          kubectl set image deployment/frontend \
            frontend=${{ env.FRONTEND_IMAGE }}:${{ steps.tag.outputs.tag }} \
            -n policy-rag

      - name: Wait for rollout
        run: |
          echo "Waiting for backend rollout..."
          kubectl rollout status deployment/backend -n policy-rag --timeout=300s

          echo "Waiting for frontend rollout..."
          kubectl rollout status deployment/frontend -n policy-rag --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n policy-rag
          echo ""
          echo "=== Services ==="
          kubectl get svc -n policy-rag
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n policy-rag

      - name: Cleanup old images
        if: always()
        run: |
          docker image prune -f --filter "until=24h" 2>/dev/null || true
